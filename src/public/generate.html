<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X402 Nano Banana - AI Image Generator</title>

    <!-- Coinbase OnchainKit -->
    <script src="https://cdn.jsdelivr.net/npm/@coinbase/onchainkit@0.38.15/dist/index.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@coinbase/onchainkit@0.38.15/dist/index.css">

    <!-- Wagmi & Viem -->
    <script src="https://cdn.jsdelivr.net/npm/viem@2.21.54/dist/viem.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@wagmi/core@2.13.8/dist/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@wagmi/connectors@5.1.9/dist/index.umd.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 700px;
            width: 100%;
            background: #fff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .wallet-section {
            background: linear-gradient(135deg, #f093fb15 0%, #f5576c15 100%);
            border-left: 4px solid #f093fb;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            text-align: center;
        }
        .wallet-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }
        .status-dot.connected {
            background: #4caf50;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .info-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        .info-card h2 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #333;
        }
        .info-card p {
            margin: 8px 0;
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }
        .info-card code {
            background-color: rgba(0,0,0,0.05);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }
        textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        textarea::placeholder {
            color: #999;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        button.secondary:hover:not(:disabled) {
            box-shadow: 0 8px 20px rgba(240, 147, 251, 0.4);
        }
        #message {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            display: none;
            word-break: break-word;
            font-size: 14px;
            line-height: 1.6;
        }
        #message.error {
            background-color: #fee;
            color: #c33;
            border: 2px solid #fcc;
        }
        #message.success {
            background-color: #efe;
            color: #2a2;
            border: 2px solid #cfc;
        }
        #message.info {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 2px solid #bbdefb;
        }
        #imageContainer {
            margin-top: 30px;
            text-align: center;
        }
        #imageContainer img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: none;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .loading-spinner {
            display: none;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-left-color: #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .char-count {
            text-align: right;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .char-count.warning {
            color: #ff9800;
        }
        .char-count.danger {
            color: #f44336;
        }
        .hidden {
            display: none !important;
        }
        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üçå X402 Nano Banana</h1>
    <p class="subtitle">AI-Powered Image Generation with Crypto Payments</p>

    <!-- Wallet Connection Section -->
    <div class="wallet-section">
        <h2>üëõ Wallet Connection</h2>
        <div class="wallet-status">
            <span class="status-dot" id="statusDot"></span>
            <span id="walletStatus">Not Connected</span>
        </div>
        <div style="margin-top: 15px;">
            <button id="connectBtn" class="secondary" onclick="connectWallet()">Connect Wallet</button>
            <button id="disconnectBtn" class="secondary hidden" onclick="disconnectWallet()">Disconnect</button>
        </div>
    </div>

    <div class="info-card">
        <h2>üí≥ Payment Information</h2>
        <p>Price: <strong><code id="price">...</code> <span id="asset">USDC</span></strong></p>
        <p>Network: <strong><code id="network">...</code></strong></p>
        <p>Recipient: <strong><code id="walletAddress" style="font-size: 11px;">...</code></strong></p>
    </div>

    <form id="generateForm">
        <div class="form-group">
            <label for="prompt">üé® Describe Your Image:</label>
            <textarea
                    id="prompt"
                    name="prompt"
                    placeholder="Example: a majestic cat astronaut floating in space, surrounded by colorful nebulas and stars, photorealistic, 4k"
                    maxlength="1000"
                    required
            ></textarea>
            <div class="char-count" id="charCount">0 / 1000</div>
        </div>
        <button type="submit" id="submitBtn" disabled>üí∞ Pay & Generate</button>
    </form>

    <div class="loading-spinner" id="loadingSpinner"></div>
    <div id="message"></div>
    <div id="imageContainer">
        <img id="generatedImage" alt="Generated Image">
    </div>
</div>

<script type="module">
    // Configuration
    let config = {
        priceInUSDC: "0.1",
        networkId: "base-sepolia",
        walletAddress: "",
        usdcContract: ""
    };

    let walletConnected = false;
    let userAddress = null;
    let provider = null;

    // DOM elements
    const form = document.getElementById('generateForm');
    const promptInput = document.getElementById('prompt');
    const messageDiv = document.getElementById('message');
    const submitButton = document.getElementById('submitBtn');
    const generatedImage = document.getElementById('generatedImage');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const charCount = document.getElementById('charCount');
    const statusDot = document.getElementById('statusDot');
    const walletStatus = document.getElementById('walletStatus');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');

    // Fetch payment info from server
    async function fetchPaymentInfo() {
        try {
            const response = await fetch('/payment-info');
            if (response.ok) {
                const data = await response.json();
                config = data;
                updatePaymentUI(data);
            }
        } catch (error) {
            console.error('Error fetching payment info:', error);
        }
    }

    function updatePaymentUI(data) {
        document.getElementById('price').textContent = data.priceInUSDC || '0.1';
        document.getElementById('network').textContent = data.networkId || 'base-sepolia';
        document.getElementById('asset').textContent = 'USDC';
        document.getElementById('walletAddress').textContent = data.walletAddress || '...';
    }

    // Network configuration
    const NETWORKS = {
        'base': {
            chainId: '0x2105',  // 8453 (Base ‰∏ªÁΩë)
            chainName: 'Base',
            rpcUrls: ['https://mainnet.base.org']
        },
        'base-sepolia': {
            chainId: '0x14a34', // 84532 (Base Sepolia ÊµãËØïÁΩë)
            chainName: 'Base Sepolia',
            rpcUrls: ['https://sepolia.base.org']
        },
        'ethereum': {
            chainId: '0x1',  // 1 (Ethereum ‰∏ªÁΩë)
            chainName: 'Ethereum',
            rpcUrls: ['https://rpc.ankr.com/eth']
        },
        'sepolia': {
            chainId: '0xaa36a7', // 11155111 (Ethereum Sepolia)
            chainName: 'Ethereum Sepolia',
            rpcUrls: ['https://rpc.sepolia.org']
        },
        'polygon': {
            chainId: '0x89',  // 137 (Polygon ‰∏ªÁΩë)
            chainName: 'Polygon',
            rpcUrls: ['https://polygon-rpc.com']
        },
        'polygon-amoy': {
            chainId: '0x13882', // 80002 (Polygon Amoy ÊµãËØïÁΩë)
            chainName: 'Polygon Amoy',
            rpcUrls: ['https://rpc-amoy.polygon.technology']
        },
        'arbitrum': {
            chainId: '0xa4b1', // 42161 (Arbitrum One)
            chainName: 'Arbitrum One',
            rpcUrls: ['https://arb1.arbitrum.io/rpc']
        },
        'arbitrum-sepolia': {
            chainId: '0x66eee', // 421614 (Arbitrum Sepolia)
            chainName: 'Arbitrum Sepolia',
            rpcUrls: ['https://sepolia-rollup.arbitrum.io/rpc']
        },
        'optimism': {
            chainId: '0xa', // 10 (Optimism Mainnet)
            chainName: 'Optimism',
            rpcUrls: ['https://mainnet.optimism.io']
        },
        'optimism-sepolia': {
            chainId: '0xaa37dc', // 11155420 (Optimism Sepolia)
            chainName: 'Optimism Sepolia',
            rpcUrls: ['https://sepolia.optimism.io']
        },
        'bnb': {
            chainId: '0x38', // 56 (BNB Smart Chain Mainnet)
            chainName: 'BNB Smart Chain',
            rpcUrls: ['https://bsc-dataseed.binance.org']
        },
        'bnb-testnet': {
            chainId: '0x61', // 97 (BNB Smart Chain Testnet)
            chainName: 'BNB Smart Chain Testnet',
            rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545']
        },
        'avalanche': {
            chainId: '0xa86a', // 43114 (Avalanche C-Chain)
            chainName: 'Avalanche',
            rpcUrls: ['https://api.avax.network/ext/bc/C/rpc']
        },
        'avalanche-fuji': {
            chainId: '0xa869', // 43113 (Avalanche Fuji Testnet)
            chainName: 'Avalanche Fuji',
            rpcUrls: ['https://api.avax-test.network/ext/bc/C/rpc']
        }
    };


    // Switch to correct network
    async function switchNetwork() {
        const targetNetwork = NETWORKS[config.networkId] || NETWORKS['base-sepolia'];

        try {
            // Try to switch to the network
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: targetNetwork.chainId }],
            });
            return true;
        } catch (switchError) {
            // This error code indicates that the chain has not been added to MetaMask
            if (switchError.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [targetNetwork],
                    });
                    return true;
                } catch (addError) {
                    console.error('Failed to add network:', addError);
                    throw new Error('Failed to add network to wallet');
                }
            }
            throw switchError;
        }
    }

    // Connect wallet using Web3 provider
    window.connectWallet = async function() {
        try {
            showMessage('info', '‚ÑπÔ∏è Connecting...', 'Please approve the wallet connection request.');

            // Check if MetaMask or other Web3 wallet is installed
            if (typeof window.ethereum === 'undefined') {
                showMessage('error', '‚ùå No Wallet Found:',
                    'Please install MetaMask, Coinbase Wallet, or another Web3 wallet to continue.');
                return;
            }

            // Request account access
            const accounts = await window.ethereum.request({
                method: 'eth_requestAccounts'
            });

            userAddress = accounts[0];
            provider = window.ethereum;

            // Check and switch network
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            const targetNetwork = NETWORKS[config.networkId] || NETWORKS['base-sepolia'];

            console.log('Current chain:', chainId, 'Target:', targetNetwork.chainId);

            if (chainId !== targetNetwork.chainId) {
                showMessage('info', 'üîÑ Switching Network...', `Please switch to ${targetNetwork.chainName} in your wallet.`);
                await switchNetwork();
            }

            // Update UI
            walletConnected = true;
            statusDot.classList.add('connected');
            walletStatus.textContent = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
            connectBtn.classList.add('hidden');
            disconnectBtn.classList.remove('hidden');
            submitButton.disabled = promptInput.value.trim().length === 0;

            hideMessage();
            showMessage('success', '‚úÖ Wallet Connected!', `Address: ${userAddress.substring(0, 10)}... on ${targetNetwork.chainName}`);

        } catch (error) {
            console.error('Wallet connection error:', error);
            showMessage('error', '‚ùå Connection Failed:', error.message);
        }
    };

    window.disconnectWallet = function() {
        walletConnected = false;
        userAddress = null;
        provider = null;
        statusDot.classList.remove('connected');
        walletStatus.textContent = 'Not Connected';
        connectBtn.classList.remove('hidden');
        disconnectBtn.classList.add('hidden');
        submitButton.disabled = true;
        hideMessage();
    };

    // Character counter
    promptInput.addEventListener('input', () => {
        const length = promptInput.value.length;
        const maxLength = 1000;
        charCount.textContent = `${length} / ${maxLength}`;

        if (length > 900) {
            charCount.classList.add('danger');
            charCount.classList.remove('warning');
        } else if (length > 750) {
            charCount.classList.add('warning');
            charCount.classList.remove('danger');
        } else {
            charCount.classList.remove('warning', 'danger');
        }

        // Enable/disable submit button
        submitButton.disabled = !walletConnected || length === 0;
    });

    // Display messages
    function showMessage(type, title, content) {
        messageDiv.className = type;
        messageDiv.innerHTML = `<strong>${title}</strong> ${content}`;
        messageDiv.style.display = 'block';
    }

    function hideMessage() {
        messageDiv.style.display = 'none';
        messageDiv.innerHTML = '';
    }

    // Send USDC payment
    async function sendPayment() {
        // Ensure we're on the correct network
        const targetNetwork = NETWORKS[config.networkId] || NETWORKS['base-sepolia'];
        const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });

        if (currentChainId !== targetNetwork.chainId) {
            showMessage('info', 'üîÑ Switching Network...', `Switching to ${targetNetwork.chainName}...`);
            await switchNetwork();
        }

        const amount = parseFloat(config.priceInUSDC);
        const amountInSmallestUnit = Math.floor(amount * 1e6); // USDC has 6 decimals

        // Encode transfer function call
        const transferData = encodeTransferData(config.walletAddress, amountInSmallestUnit);

        // Send transaction
        const txHash = await window.ethereum.request({
            method: 'eth_sendTransaction',
            params: [{
                from: userAddress,
                to: config.usdcContract,
                data: transferData,
                gas: '0x186A0', // 100000 gas
            }]
        });

        return txHash;
    }

    // Simple ABI encoding for transfer(address,uint256)
    function encodeTransferData(to, amount) {
        const methodId = '0xa9059cbb'; // transfer(address,uint256)
        const addressParam = to.substring(2).padStart(64, '0');
        const amountParam = amount.toString(16).padStart(64, '0');
        return methodId + addressParam + amountParam;
    }

    // Handle form submission
    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        if (!walletConnected) {
            showMessage('error', '‚ùå Error:', 'Please connect your wallet first.');
            return;
        }

        const prompt = promptInput.value.trim();

        if (!prompt) {
            showMessage('error', '‚ùå Error:', 'Please enter a prompt to generate an image.');
            return;
        }

        // Reset UI
        hideMessage();
        generatedImage.style.display = 'none';
        generatedImage.src = '';
        loadingSpinner.style.display = 'block';
        submitButton.disabled = true;
        submitButton.textContent = 'üí≥ Processing Payment...';

        try {
            // Step 1: Ensure correct network
            const targetNetwork = NETWORKS[config.networkId] || NETWORKS['base-sepolia'];
            const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });

            if (currentChainId !== targetNetwork.chainId) {
                showMessage('info', 'üîÑ Network Check:', `Switching to ${targetNetwork.chainName}...`);
                await switchNetwork();
            }

            // Step 2: Send payment
            showMessage('info', '‚ÑπÔ∏è Payment Required:', 'Please approve the USDC transfer in your wallet...');

            const txHash = await sendPayment();
            console.log('Payment transaction:', txHash);

            submitButton.textContent = '‚è≥ Generating Image...';
            showMessage('info', '‚ÑπÔ∏è Payment Sent:', 'Waiting for confirmation and generating your image...');

            // Step 2: Generate image with payment proof
            const response = await fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'image/png',
                    'X-Payment-Tx': txHash // Include payment tx hash
                },
                body: JSON.stringify({ prompt })
            });

            loadingSpinner.style.display = 'none';
            submitButton.disabled = false;
            submitButton.textContent = 'üí∞ Pay & Generate';

            if (!response.ok) {
                let errorData = null;
                const contentType = response.headers.get('content-type') || '';

                try {
                    if (contentType.includes('application/json')) {
                        errorData = await response.json();
                    } else {
                        const text = await response.text();
                        errorData = { message: text };
                    }
                } catch (e) {
                    errorData = { message: 'Unknown error occurred' };
                }

                const errorMsg = errorData.message || errorData.error || 'Image generation failed';
                showMessage('error', `‚ùå Error (${response.status}):`, errorMsg);
            } else {
                // Success - display image
                const imageBlob = await response.blob();
                const imageUrl = URL.createObjectURL(imageBlob);
                generatedImage.src = imageUrl;
                generatedImage.style.display = 'block';
                generatedImage.scrollIntoView({ behavior: 'smooth', block: 'center' });

                showMessage('success', '‚ú® Success!', 'Your image has been generated successfully!');

                // Clear the prompt for next generation
                promptInput.value = '';
                charCount.textContent = '0 / 1000';
                charCount.classList.remove('warning', 'danger');
                submitButton.disabled = true;
            }
        } catch (error) {
            console.error('Error:', error);
            loadingSpinner.style.display = 'none';
            submitButton.disabled = false;
            submitButton.textContent = 'üí∞ Pay & Generate';

            if (error.code === 4001) {
                showMessage('info', '‚ÑπÔ∏è Cancelled:', 'Payment was cancelled by user.');
            } else {
                showMessage('error', '‚ùå Error:',
                    `${error.message}<br><small>Please check your wallet and try again.</small>`);
            }
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        fetchPaymentInfo();

        // Check if wallet is already connected
        if (window.ethereum) {
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) {
                        userAddress = accounts[0];
                        provider = window.ethereum;
                        walletConnected = true;
                        statusDot.classList.add('connected');
                        walletStatus.textContent = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                        connectBtn.classList.add('hidden');
                        disconnectBtn.classList.remove('hidden');
                    }
                });

            // Listen for network changes
            window.ethereum.on('chainChanged', (chainId) => {
                console.log('Network changed to:', chainId);
                const targetNetwork = NETWORKS[config.networkId] || NETWORKS['base-sepolia'];
                if (chainId !== targetNetwork.chainId) {
                    showMessage('info', '‚ö†Ô∏è Wrong Network:',
                        `Please switch to ${targetNetwork.chainName} network to make payments.`);
                } else {
                    hideMessage();
                }
            });

            // Listen for account changes
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // User disconnected wallet
                    window.disconnectWallet();
                } else if (accounts[0] !== userAddress) {
                    // User switched account
                    userAddress = accounts[0];
                    walletStatus.textContent = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                    showMessage('info', 'üîÑ Account Changed:', `Now using ${userAddress.substring(0, 10)}...`);
                }
            });
        }

        // Load prompt from URL if present
        const urlParams = new URLSearchParams(window.location.search);
        const promptFromUrl = urlParams.get('prompt');
        if (promptFromUrl) {
            promptInput.value = promptFromUrl;
            promptInput.dispatchEvent(new Event('input'));
        }
    });
</script>
</body>
</html>